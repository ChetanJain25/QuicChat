<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuicChat</title>
    
    <style>
        /* SIMPLE MODERN DARK THEME */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        #chat-container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            background-color: #1e1e1e;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
        }
        h1 {
            text-align: center;
            color: #ffffff;
            border-bottom: 1px solid #333;
            padding: 15px;
            margin: 0;
            font-size: 1.2rem;
            cursor: pointer;
        }
        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .message {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            max-width: 80%;
            align-self: flex-start;
            cursor: pointer;
        }
        .avatar-initial {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        .message-content {
            background-color: #333333;
            padding: 6px 12px;
            border-radius: 6px;
            word-wrap: break-word;
        }
        .message strong {
            font-size: 0.9rem;
            color: #ececf1;
            font-weight: 500;
        }
        #message-form {
            display: flex;
            padding: 15px;
            border-top: 1px solid #333;
            align-items: center;
        }
        #message-input {
            flex-grow: 1;
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #555;
            border-radius: 18px;
            padding: 10px 15px;
            font-size: 1rem;
        }
        #send-button {
            background-color: #3a77d1;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-left: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .my-message {
            align-self: flex-end;
        }
        .my-message strong {
             display: none;
        }
        .message p {
            margin: 2px 0 0 0;
            font-size: 0.95rem;
            color: #e9edef;
        }
        .message small {
            display: block;
            text-align: right;
            opacity: 0.7;
            font-size: 0.65rem; 
            margin-top: 4px;
        }
        .like-counter {
            font-size: 0.7rem;
            color: #aaa;
            margin-top: 4px;
            text-align: right;
        }
        #info-note {
            position: fixed; right: 0; top: 50%; transform: translateY(-50%);
            background-color: #1e1e1e; padding: 10px 5px; font-size: 0.75rem; color: #888;
            border: 1px solid #333; border-right: none; border-radius: 8px 0 0 8px; writing-mode: vertical-rl;
        }
        #info-note p { margin: 0; padding: 0; }
        #messages::-webkit-scrollbar { width: 8px; }
        #messages::-webkit-scrollbar-track { background: transparent; }
        #messages::-webkit-scrollbar-thumb { background-color: #555; border-radius: 4px; }
        #messages::-webkit-scrollbar-thumb:hover { background-color: #777; }
        .message-content a {
            color: #8ab4f8;
        }
    </style>
</head>
<body>

    <div id="chat-container">
        <h1>QuicChat</h1>
        <div id="messages">
            </div>
        <div id="message-form">
            <input type="text" id="message-input" placeholder="Type a message">
            <button id="send-button" title="Send">‚û§</button>
        </div>
    </div>

    <div id="info-note">
        <p><strong>Note:</strong> F12 ‚Üí Application ‚Üí Local Storage</p>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
    
    <script>
        // Your unique Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBsNKN5JNiMdpMoMhFH1Wms60otBu-nOh0",
          authDomain: "quicchat-38163.firebaseapp.com",
          projectId: "quicchat-38163",
          storageBucket: "quicchat-38163.firebasestorage.app",
          messagingSenderId: "36420691052",
          appId: "1:36420691052:web:3442550b2b0c1dbbf42449",
          measurementId: "G-5DD65Z9CK2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const titleElement = document.querySelector('h1');

        function getUsername() {
            let storedName = localStorage.getItem('quicchat_username');
            if (storedName) { return storedName; }
            else {
                const newName = prompt("Please enter your name:") || "Anonymous";
                localStorage.setItem('quicchat_username', newName);
                return newName;
            }
        }
        const username = getUsername();

        titleElement.addEventListener('click', () => {
            const newName = prompt("Enter a new name:", username);
            if (newName && newName !== username) {
                localStorage.setItem('quicchat_username', newName);
                alert("Name changed. Please refresh.");
                location.reload();
            }
        });

        // --- NEW: Notification Logic ---
        // 1. Ask for permission when the app loads
        if (Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        function showNotification(username, text) {
            // Only show notification if the tab is not active
            if (document.hidden) {
                const notification = new Notification(username, {
                    body: text,
                    icon: 'https://i.ibb.co/68c8xR7/quicchat-icon.png' // A generic icon
                });

                // When notification is clicked, focus the chat window
                notification.onclick = () => {
                    window.focus();
                };
            }
        }

        function generateColorForUser(username) {
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = hash % 360;
            return `hsl(${h}, 60%, 45%)`;
        }

        function linkify(text) {
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            return text.replace(urlRegex, function(url) {
                return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
            });
        }
        
        db.collection("messages").orderBy("timestamp", "asc")
            .onSnapshot((snapshot) => {
                const isScrolledToBottom = messagesDiv.scrollHeight - messagesDiv.clientHeight <= messagesDiv.scrollTop + 10;
                
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const message = change.doc.data();
                        displayMessage(change.doc.id, message);
                        // 2. Trigger notification for new messages from others
                        if (message.username !== username) {
                            showNotification(message.username, message.text);
                        }
                    }
                    if (change.type === "modified") {
                        updateMessage(change.doc.id, change.doc.data());
                    }
                    if (change.type === "removed") {
                        const messageElement = document.getElementById(`msg-${change.doc.id}`);
                        if (messageElement) { messageElement.remove(); }
                    }
                });

                if (isScrolledToBottom) {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            });

        function displayMessage(id, message) {
            const messageElement = document.createElement("div");
            messageElement.classList.add("message");
            messageElement.id = `msg-${id}`;
            messageElement.dataset.id = id;

            if (message.username === username) {
                messageElement.classList.add("my-message");
            }

            const likes = message.likes || [];
            const likeCount = likes.length > 0 ? `üëç ${likes.length}` : '';
            
            const sentTime = message.timestamp ? message.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
            const initial = message.username ? message.username.charAt(0).toUpperCase() : '?';
            const avatarColor = generateColorForUser(message.username || "Anonymous");
            
            const messageText = message.text ? linkify(message.text) : '';
            
            messageElement.innerHTML = `
                <div class="avatar-initial" style="background-color: ${avatarColor};">
                    ${initial}
                </div>
                <div class="message-content">
                    <strong>${message.username}</strong>
                    <p>${messageText}</p>
                    <div class="like-counter">${likeCount}</div>
                    <small>${sentTime}</small>
                </div>
            `;
            messagesDiv.appendChild(messageElement);
        }

        function updateMessage(id, message) {
            const messageElement = document.getElementById(`msg-${id}`);
            if (!messageElement) return;

            const likes = message.likes || [];
            const likeCount = likes.length > 0 ? `üëç ${likes.length}` : '';
            messageElement.querySelector('.like-counter').textContent = likeCount;
        }
        
        messagesDiv.addEventListener('dblclick', (e) => {
            const messageElement = e.target.closest('.message');
            if (!messageElement) return;
            
            const messageId = messageElement.dataset.id;
            const messageRef = db.collection("messages").doc(messageId);

            db.runTransaction(async (transaction) => {
                const messageDoc = await transaction.get(messageRef);
                if (!messageDoc.exists) return;

                const likes = messageDoc.data().likes || [];
                if (likes.includes(username)) {
                    const newLikes = likes.filter(u => u !== username);
                    transaction.update(messageRef, { likes: newLikes });
                } else {
                    transaction.update(messageRef, { likes: [...likes, username] });
                }
            });
        });

        messagesDiv.addEventListener('contextmenu', (e) => {
            const messageElement = e.target.closest('.my-message');
            if (!messageElement) return;

            e.preventDefault();
            const messageId = messageElement.dataset.id;
            if (confirm("Are you sure you want to delete this message?")) {
                db.collection("messages").doc(messageId).delete();
            }
        });

        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (messageText !== "") {
                db.collection("messages").add({
                    username: username,
                    text: messageText,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    likes: []
                }).then(() => {
                    messageInput.value = "";
                });
            }
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>

</body>
</html>
